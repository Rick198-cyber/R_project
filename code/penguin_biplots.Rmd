---
title: 'Penguin data: PCA & Biplots'
author: "Michael Friendly"
date: "6/10/2020"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(here)
# library(car)
# library(heplots)
# library(candisc)
options(digits = 5)
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      error = FALSE)
```

Penguins are **multivariate** creatures! Give them their due.
Here we examine a basic set of multivariate views of these pengiuns.

* An informative scatterplot matrix (`car::scatterplotMatrix`)
* A principal components analysis (`princomp()`) followed by 
* a biplot (`ggbiplot`), showing the observations in the space of the first two principal components (PC1, PC2) and variable vectors showing the correlations of the penguin quantitative variables with PC1 & PC2.

This analysis gives a new perspective on this data set.  We will see that there is a simple multivariate explanation to the variation of pengiuns, both between species and within a given species.


## Load the `penguins` data and do some clean up

These examples use the simplified `penguins` dataset. 

```{r}
data(penguins, package="penguins")
```

For this example: 

* shorten variable names (remove units) to simplify variable labels,
* create factors for character variables (needed for MANOVA), and 
* remove NA observations (causes problems with PCA)

```{r}
peng <- penguins %>%
	rename(
         culmen_length = culmen_length_mm, 
         culmen_depth = culmen_depth_mm, 
         flipper_length = flipper_length_mm, 
         body_mass = body_mass_g
         ) %>%
  mutate(species = as.factor(species),
         island = as.factor(island),
         sex = as.factor(sex)) %>%
  filter(!is.na(culmen_depth))
```

Take a peek at the tibble:

```{r peng}
peng
```

## Load our packages

```{r load-pkgs}
library(car)
library(ggbiplot)
# library(GGally)
```



## Scatterplot matrix

For multivariate data, rather than making separate bivariate scatterplots
a more more comprehensive view is given by a scatterplot matrix -- all
pairwise plots of a set of quantitative varibles.

In base R, this would be easily done with the `pairs()` function. ...

But there are better alternatives:

* `car::scatterplotMatrix()` provides many options for enhancing the basic `pairs()` plot. 

* in particular, in the model formula, `x1 + x2 + ... | group`, the different
groups (`species`) are annotated and colored separately.

* the diagonal panels show the univariate distributions for each group. This shows a smoothed density estimate for each group, and you can easily see the difference
among species in terms of means, variablilty and shape.

* each pairwise panel shows a data ellipse 



```{r spm, fig.height=7, fig.width=7}
scatterplotMatrix(~ culmen_length + culmen_depth + flipper_length + body_mass | species,
                  data=peng,
                  ellipse=list(levels=0.68))

```



## PCA

We can think of principal component analysis as a multivariate juicer: it tries to squeeze as much flavor out of a multivariate sample, when the criterion for "flavor" is the greatest amount of variance accounted for in 1, 2, 3, ...
dimensions (weighted sums of the variables.)

We run the PCA with `prcomp()`. Because the variable scales are not all commensurable, it is important to scale them to equal variance.

```{r peng-pca}
peng.pca <- prcomp (~ culmen_length + culmen_depth + flipper_length + body_mass,
                    data=peng,
                    na.action=na.omit,  # not actually necessary: we removed NA
                    scale. = TRUE)

peng.pca

```
How many dimensions are useful and necessary to portray the variation among
penquins on these variables?  It looks like two are sufficient.
(The usual simple criterion is to look for the "elbow" in a screeplot.)

```{r screeplot}
screeplot(peng.pca, type = "line", lwd=3, cex=3, 
		main="Variances of PCA Components")
```

### Biplot 

The results of a PCA can best be viewed as a biplot. This shows

* the observations in the space of PC1 and PC2. Data ellipses for each color show the within-species variation. 
* the pengiun size variables are represented as vectors from the origin. The angles they make with the PC1 and PC2 axes reflect their correlations with the principal components.

In the call to `ggbiplot`, 

* `groups = peng$species` provides separate colors and point styles for the species.
* `ellipse = TRUE` causes a data ellipse to be drawn for each species.  This shows the within-species correlations of the observation scores on PC1 & PC2.
* `circle = TRUE` draws a correlation circle, reflecting the fact that for all species combined, PC1 & PC2 are uncorrelated.

```{r}
ggbiplot(peng.pca, obs.scale = 1, var.scale = 1,
         groups = peng$species, 
         ellipse = TRUE, circle = TRUE) +
  scale_color_discrete(name = 'Penguin Species') +
  theme_minimal() +
  theme(legend.direction = 'horizontal', legend.position = 'top') 


```

From this, we can see:

* These two principal components account for 68.8 + 19.3 = 88.1 % of the total
variance of these four size variables.

* PC1 is largely determined by flipper length and body mass. We can interpret this as an overall measure of **penguin size**.

* On this dimension, Gentoos are the largest, by quite a lot, compared with Adelie and Chinstrap.

* PC2 is mainly determined by variation in the two beak variables: culmen length and depth. Chinstrap are lower than the other two species on culmen length and depth, but culmen length further distinguishes the Gentoos. A penguin biologist could almost certainly provide an explanation, but I'll call this **beak shape**.

